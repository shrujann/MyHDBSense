<!DOCTYPE html>
<html lang="en">
    {% load static %}
<head>
    <meta charset="UTF-8">
    <title>Nearby HDB Resale Flats</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        body { font-family: Arial, sans-serif; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th { background-color: #f2f2f2; }
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>

<h2>Nearby Flats (within 3 km)</h2>

{% if flats %}
    <table>
        <tr>
            <th>Town</th>
            <th>Flat Type</th>
            <th>Model</th>
            <th>Floor Area (sqm)</th>
            <th>Lease Commence</th>
            <th>Price (S$)</th>
            <th>Distance (km)</th>
        </tr>
        {% for f in flats %}
        <tr>
            <td>{{ f.town }}</td>
            <td>{{ f.flat_type }}</td>
            <td>{{ f.model }}</td>
            <td>{{ f.floor_area }}</td>
            <td>{{ f.lease_commence }}</td>
            <td>{{ f.resale_price }}</td>
            <td>{{ f.distance }}</td>
        </tr>
        {% endfor %}
    </table>

 <!-- Map container -->
<div id="map" style="height: 500px;"></div>

<!-- Hidden JSON data -->
{{ flats|json_script:"flats-data" }}

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Get center coordinates from Django
    var center = [parseFloat("{{ center_lat }}"), parseFloat("{{ center_lng }}")];

    // Parse flats JSON from the hidden script
    var flats = JSON.parse(document.getElementById("flats-data").textContent);

    // Initialize map
    var map = L.map("map").setView(center, 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);

    // Step 2: Draw a 3 km radius circle around center
    var circle = L.circle(center, {
        radius: 3000,  // 3000 meters = 3 km
        color: "blue",
        fillColor: "#cce5ff",
        fillOpacity: 0.2
    }).addTo(map);

    // Step 3: Define a custom house icon
    var houseIcon = L.icon({
        iconUrl: "{% static 'accounts/icons/house.svg' %}", // place house.svg in static/accounts/icons
        iconSize: [30, 30],  // adjust size as needed
        iconAnchor: [15, 30], // so it points at the location properly
        popupAnchor: [0, -28]
    });

    // Step 4: Add markers with custom icon
    flats.forEach(f => {
        if (f.latitude && f.longitude) {
            L.marker([f.latitude, f.longitude], {icon: houseIcon})
              .addTo(map)
              .bindPopup(
                `<b>${f.town}</b><br>${f.flat_type}<br>Price: $${f.resale_price}<br>Distance: ${f.distance} km`
              );
        }
    });
</script>


<!-- Debug -->
<p>
    Center coordinates: Latitude = {{ center_lat }}, Longitude = {{ center_lng }}
</p>


{% else %}
    <p>No flats found within 3 km of that postal code.</p>
{% endif %}

</body>
</html>
