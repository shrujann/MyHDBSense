<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Results</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f9;
    }

    .thread {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #fff;
    }

    .thread-title {
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }

    .thread-meta {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }

    .thread-content {
      font-size: 16px;
      color: #333;
    }

    .map-container {
      margin-bottom: 20px;
    }

    .return-logo img {
      width: 30px;
      height: auto;
    }

    /* Adjust styles for the upvote button and count */
    .vote-form {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .vote-bubble {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 50px;
      padding: 5px 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .vote-form button {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }

    .vote-form button svg {
      width: 20px;
      height: 20px;

    }

    .vote-count {
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <a href="{% url 'mappage' %}" class="return-logo">    
    <img src="https://img.icons8.com/ios-filled/50/000000/left.png" alt="Return to Map">
    </a>
  </div>
  <h1>User Submitted Requests</h1>
  {% for loc in locations %}
  <div class="thread">
    <div class="thread-title">{{ loc.amenity|upper }}</div>
    <div class="thread-meta"><p>Address: {{ loc.address|default:"Address not available" }}</p></div>
    <div class="thread-content">{{ loc.description }}</div>
    <form class="vote-form" action="{% url 'upvote_location' loc.id %}" method="POST">
      {% csrf_token %}
      <div class="vote-bubble">
        <button type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 2l7 12H5z"/>
          </svg>
        </button>
        <span class="vote-count">{{ loc.upvoteCount }}</span>
      </div>
    </form>
  </div>
  {% endfor %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const voteForms = document.querySelectorAll('.vote-form');

        voteForms.forEach(form => {
            form.addEventListener('submit', function(e) {

                e.preventDefault();

                // Disable the button to prevent multiple upvotes
                const button = form.querySelector('button[type="submit"]');
                button.disabled = true;
                button.textContent = "Voted"; // Indicate that the user has already voted

                const formData = new FormData(form);
                const url = form.action;
                const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    console.log(response); // Log the response for debugging
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const voteCount = form.querySelector('.vote-count');
                    voteCount.textContent = data.upvoteCount;
                })
                .catch(error => {
                    console.error('Error:', error); // Log the error for debugging
                    // Re-enable the button if there's an error
                    button.disabled = false;
                    button.textContent = "Vote"; // Reset the button text
                });
            }); 
        }); 
    }); 
  </script>

</body>
</html>

