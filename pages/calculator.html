<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MyHDBSense | Calculator</title>

  <!-- Bootstrap + Site Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../assets/style.css"/>

  <style>
    :root{
      --ink:#0b0d14;
      --muted:#6b7280;
      --border:#e9edf2;
      --soft:#f7f8fb;
      --card-r:16px;
      --btn:#111827;
      --success-bg:#e9f7ed;
      --success-border:#bfe8cc;
      --success-text:#075e2b;
    }

    body{ background:#fbfcfe; color:var(--ink); }

    /* Page header */
    .calc-wrap{ max-width:1120px; margin:0 auto; }
    .page-title{ font-weight:800; font-size:2.4rem; letter-spacing:-.01em; }
    .page-sub{ color:var(--muted); font-size:1.02rem; }

    /* Main card (inputs) — centered, same look as your other pages */
    .mhs-card{
      background:#fff; border:1px solid var(--border); border-radius:20px;
      box-shadow:0 10px 26px rgba(10,31,68,.06);
      max-width:880px; margin:0 auto;  /* centered card under the left-aligned heading */
    }
    .section-caption{ font-weight:700; }

    .form-label{ font-weight:600; color:#0f172a; }
    .form-control, .form-select{
      border-radius:12px; padding:.9rem 1rem; border-color:#dfe3eb;
      background:#fff;
    }
    .form-text-lite{ color:#6b7280; font-size:.9rem; }

    /* CTA button — dark pill */
    .cta{
      background:var(--btn); border-color:var(--btn); border-radius:999px;
      padding:1rem 1.1rem; font-weight:800; letter-spacing:.1px;
    }
    .cta:hover{ background:#0b0f1a; border-color:#0b0f1a; }

    /* Results */
    #results{ max-width:880px; margin:0 auto; }
    .summary-band{
      background:var(--success-bg); border:1px solid var(--success-border);
      border-radius:16px; padding:1.05rem 1.2rem;
    }
    .summary-band h3{ margin:0; font-weight:900; color:var(--success-text); }
    .summary-k{ color:#1f2937; font-weight:600; font-size:.92rem; }

    .result-card{
      background:#fff; border:1px solid var(--border); border-radius:16px;
      box-shadow:0 8px 18px rgba(10,31,68,.06);
    }
    .result-card .card-header{
      background:#fff; border-bottom:1px solid var(--border); font-weight:700;
    }
    .kv{ display:flex; justify-content:space-between; padding:.5rem 0; font-size:.96rem; }
    .kv .k{ color:#374151; }
    .kv .v{ color:#0b0d14; font-weight:800; }
    .kv .v.blue{ color:#2563eb; }

    .notes{
      background:#eef3ff; border:1px solid #dae6ff; border-radius:16px; padding:1rem;
    }
    .notes li{ margin:.35rem 0; color:#374151; font-size:.95rem; }

    @media (max-width: 991.98px){
      .page-title{ font-size:2rem; }
      .mhs-card, #results{ max-width:100%; }
    }
  </style>
</head>
<body>

  <!-- Shared navbar + back button (matches Amenities page) -->
  <div data-include="../assets/components/navbar.html"></div>
  <div data-include="../assets/components/backhome.html"></div>

  <main class="calc-wrap px-3 px-md-4 py-4 py-lg-5">
    <!-- Left-aligned header; card below is centered as in your screenshots -->
    <header class="mb-4">
      <h2 class="page-title mb-1">HDB Affordability Calculator</h2>
      <p class="page-sub mb-0">Calculate your HDB affordability with TDSR/MSR rules and CPF OA integration.</p>
    </header>

    <!-- Input Card -->
    <section class="mhs-card p-3 p-md-4 mb-4">
      <div class="d-flex align-items-center gap-2 mb-2">
        <i class="bi bi-wallet2"></i>
        <span class="section-caption">Income &amp; Financial Details</span>
      </div>

      <form id="calcForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Monthly Gross Income (SGD)</label>
          <input id="inc" type="number" class="form-control" placeholder="e.g. 6000" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Monthly Expenses (SGD)</label>
          <input id="exp" type="number" class="form-control" placeholder="e.g. 2000" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">CPF OA Balance (SGD)</label>
          <input id="cpfBal" type="number" class="form-control" placeholder="e.g. 80000" required>
          <div class="form-text-lite">Can be used for down payment and monthly servicing</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Cash Available for Down Payment (SGD)</label>
          <input id="cashBal" type="number" class="form-control" placeholder="e.g. 50000" required>
        </div>

        <div class="col-md-8">
          <label class="form-label">Property Type</label>
          <select id="ptype" class="form-select">
            <option value="HDB_20" selected>HDB (20% down payment)</option>
            <option value="BANK_25">Bank Loan (25% down payment)</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Loan Tenure (Years)</label>
          <input id="tenure" type="number" min="5" max="30" value="25" class="form-control"/>
        </div>

        <div class="col-12">
          <button id="btnCalc" class="btn cta w-100">Calculate My HDB Affordability</button>
        </div>
      </form>
    </section>

    <!-- Results (hidden until calculated) -->
    <section id="results" class="d-none mb-4">
      <div class="summary-band mb-3">
        <div class="row g-3 align-items-center">
          <div class="col-md-6">
            <div class="summary-k">Maximum Property Price</div>
            <h3 id="sumPrice">$0</h3>
          </div>
          <div class="col-md-6">
            <div class="summary-k">Monthly Payment</div>
            <h3 id="sumMonthly">$0</h3>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-lg-6">
          <div class="result-card card h-100">
            <div class="card-header">Down Payment Breakdown</div>
            <div class="card-body">
              <div class="kv"><span class="k">Required Down Payment</span><span id="dpRequired" class="v">$0</span></div>
              <div class="kv"><span class="k">From CPF OA</span><span id="dpFromCPF" class="v blue">$0</span></div>
              <div class="kv"><span class="k">Cash Required</span><span id="dpCashReq" class="v">$0</span></div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="result-card card h-100">
            <div class="card-header">Monthly Servicing</div>
            <div class="card-body">
              <div class="kv"><span class="k">Available for Servicing</span><span id="msrAvail" class="v">$0</span></div>
              <div class="kv"><span class="k">Monthly CPF OA Contribution</span><span id="msrCPF" class="v blue">$0</span></div>
              <div class="kv"><span class="k">Actual Monthly Payment</span><span id="msrActual" class="v">$0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="notes">
        <div class="fw-semibold mb-1">Important Notes</div>
        <ul class="mb-0">
          <li>Calculator applies MSR (30%) and TDSR (55%) caps.</li>
          <li>CPF OA can be used for down payment and monthly servicing (~20% of monthly salary).</li>
          <li>Buyer’s Stamp Duty, legal fees and renovation are excluded.</li>
          <li>Final loan approval depends on HDB/bank assessment and credit profile.</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="text-center py-4 small text-muted">© 2025 MyHDBSense. All rights reserved.</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/main.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const fmt = n => "$" + Math.round(+n).toLocaleString();

    function pvFromPMT(pmt, r, n){ return r<=0 ? pmt*n : pmt*(1-Math.pow(1+r,-n))/r; }
    function pmtFromPV(pv, r, n){ return r<=0 ? pv/n : pv*r/(1-Math.pow(1+r,-n)); }

    $("btnCalc").addEventListener("click", e => {
      e.preventDefault();

      const income  = +$("inc").value || 0;
      const exp     = +$("exp").value || 0;
      const cpfBal  = +$("cpfBal").value || 0;
      const cashBal = +$("cashBal").value || 0;
      const tenureY = +$("tenure").value || 25;
      const scheme  = $("ptype").value;

      const dpRate = scheme === "BANK_25" ? 0.25 : 0.20;
      const ltv = 1 - dpRate;

      const annualRate = scheme === "BANK_25" ? 0.042 : 0.026;   // bank ~4.2%, HDB 2.6%
      const r = annualRate/12;
      const n = tenureY*12;

      // Affordability caps
      const msrCap  = income * 0.30;                 // Mortgage Servicing Ratio (30%)
      const tdsrCap = Math.max(0, income*0.55 - exp); // Total Debt Servicing Ratio (55% – expenses)
      const availForLoan = Math.min(msrCap, tdsrCap);

      // CPF monthly contribution usable for servicing (~20% of salary)
      const cpfMonthly = income * 0.20;

      // Total monthly available for instalment (cash/Net + CPF)
      const monthlyBudget = availForLoan + cpfMonthly;

      // Loan amount from monthly budget
      const loanFromBudget = pvFromPMT(monthlyBudget, r, n);

      // Property price from loan + down payment structure
      const priceByLoan = loanFromBudget / ltv;

      // Property price limited by upfront funds
      const upfrontFunds = cpfBal + cashBal;
      const priceByDown = upfrontFunds / dpRate;

      // Final max price is min of (loan capacity) and (downpayment capacity)
      const maxPrice = Math.min(priceByLoan, priceByDown);

      const loanAmt = maxPrice * ltv;
      const dpRequired = maxPrice * dpRate;

      // Allocate down payment (CPF first, rest cash)
      const cpfUsed = Math.min(cpfBal, dpRequired);
      const cashReq = Math.max(0, dpRequired - cpfUsed);

      // Actual monthly instalment for that loan
      const actualPMT = pmtFromPV(loanAmt, r, n);

      // Render
      $("sumPrice").textContent   = fmt(maxPrice);
      $("sumMonthly").textContent = fmt(actualPMT);

      $("dpRequired").textContent = fmt(dpRequired);
      $("dpFromCPF").textContent  = fmt(cpfUsed);
      $("dpCashReq").textContent  = fmt(cashReq);

      $("msrAvail").textContent   = fmt(availForLoan);
      $("msrCPF").textContent     = fmt(cpfMonthly);
      $("msrActual").textContent  = fmt(actualPMT);

      $("results").classList.remove("d-none");
      window.scrollTo({ top: document.querySelector("#results").offsetTop - 80, behavior: "smooth" });
    });
  </script>
</body>
</html>